@page "/reports"

@rendermode InteractiveServer

<h3>Reports</h3>

@code {
    /*
     * need to be refactored
     * need to be refactored
     * need to be refactored
     * need to be refactored
     * need to be refactored
     */
    bool ShowStories = false;
    bool ShowComments = false;
    bool ShowRequests = false;

    //reports bag :D
    StoryReportDtoPageResponse? StoryReports { get; set; }

    ReviewReportDtoPageResponse? ReviewReports { get; set; }

    StoryReleaseRequestDetailsDtoPageResponse? StoryReleaseRequests { get; set; }


    bool IsReportAccepted = false;
    string? SpecialMessage;

    protected override async Task OnInitializedAsync()
    {

    }

    async Task UpdateStoryReports()
    {
        try
        {
            var apiRes = await clientAli.AvailableStoryReportsAsync(new BaseRequest() { PageNumber = 1, PageSize = 10});

            if (apiRes.Success)
            {
                StoryReports = apiRes;

                StateHasChanged();
            }
            else
                msgService.ShowMessage(apiRes.Message, "error");
        }
        catch (Exception e) { msgService.ShowMessage(e.Message, "error"); }
    }

    async Task UpdateReviewReports()
    {
        try
        {
            var apiRes = await clientAli.AvailableReviewReportsAsync(new BaseRequest() { PageNumber = 1, PageSize = 10 });

            if (apiRes.Success)
            {
                ReviewReports = apiRes;

                StateHasChanged();
            }
            else
                msgService.ShowMessage(apiRes.Message, "error");
        }
        catch (Exception e) { msgService.ShowMessage(e.Message, "error"); }
    }

    async Task UpdateReleaseRequests()
    {
        try
        {
            var apiRes = await clientAli.AvailableReleaseRequestsAsync(new BaseRequest() { PageNumber = 1, PageSize = 10 });

            if (apiRes.Success)
            {
                StoryReleaseRequests = apiRes;

                StateHasChanged();
            }
            else
                msgService.ShowMessage(apiRes.Message, "error");
        }
        catch (Exception e) { msgService.ShowMessage(e.Message, "error"); }
    }

    async void CompeleteStoryReport(Guid storyReportGuid)
    {
        ReportCompleteDto sendingDto = new ReportCompleteDto()
        {
            ReportGuid = storyReportGuid,
            IsAccepted = IsReportAccepted,
            SpicialMessage = SpecialMessage
        };

        try
        {
            var apiRes = await clientAli.CompleteReportStoryAsync(sendingDto);

            if (apiRes.Success)
            {
                msgService.ShowMessage(apiRes.Message, "success");

                await UpdateStoryReports();

                ClearLocalVariables();

                StateHasChanged();
            }
            else
                msgService.ShowMessage(apiRes.Message, "error");
        }
        catch (Exception e) { msgService.ShowMessage(e.Message, "error"); }
    }

    async void CompeleteCommentReport(Guid reviewReporyGuid)
    {
        ReportCompleteDto sendingDto = new ReportCompleteDto()
        {
            ReportGuid = reviewReporyGuid,

            IsAccepted = IsReportAccepted,
            SpicialMessage = SpecialMessage
        };

        try
        {
            var apiRes = await clientAli.CompleteReportReviewAsync(sendingDto);

            if (apiRes.Success)
            {
                msgService.ShowMessage(apiRes.Message, "success");

                await UpdateStoryReports();

                ClearLocalVariables();

                StateHasChanged();
            }
            else
                msgService.ShowMessage(apiRes.Message, "error");
        }
        catch (Exception e) { msgService.ShowMessage(e.Message, "error"); }
    }

    async void CompeleteReleaseRequest(Guid releaseReqGuid)
    {
        ReportCompleteDto sendingDto = new ReportCompleteDto()
        {
            ReportGuid = releaseReqGuid,
            IsAccepted = IsReportAccepted,
            SpicialMessage = SpecialMessage
        };

        try
        {
            var apiRes = await clientAli.CompleteReportReleaseRequestAsync(sendingDto);

            if (apiRes.Success)
            {
                msgService.ShowMessage(apiRes.Message, "success");

                await UpdateStoryReports();

                ClearLocalVariables();

                StateHasChanged();
            }
            else
                msgService.ShowMessage(apiRes.Message, "error");
        }
        catch (Exception e) { msgService.ShowMessage(e.Message, "error"); }
    }

    void ClearLocalVariables()
    {
        SpecialMessage = "";
        IsReportAccepted = false;
        StateHasChanged();
    }

    async Task StoryReportsListStates()
    {
        ShowStories = !ShowStories;

        if(StoryReports == null && ShowStories)
            await UpdateStoryReports();

        StateHasChanged();
    }

    async Task ReivewReportsListStates()
    {
        ShowComments = !ShowComments;

        if (ReviewReports == null && ShowComments)
            await UpdateReviewReports();

        StateHasChanged();
    }

    async Task ReleaseRequestsListStates()
    {
        ShowRequests = !ShowRequests;

        if (StoryReleaseRequests == null && ShowRequests)
            await UpdateReleaseRequests();

        StateHasChanged();
    }

}

<div class="reports-container">

    <!-- داستان ها -->
    <button class="accordion-button" @onclick="StoryReportsListStates">
        <span>گزارشات داستان‌ها</span>
        <span class="report-count">@StoryReports?.TotalItems</span>
    </button>

    <div class="accordion-content" style="display:@(ShowStories ? "block" : "none")">
        @if (StoryReports == null)
        {
            <p style="color:yellow">بارگذاری نشده...</p>
        }
        else if (StoryReports.TotalItems == 0)
        {
            <p style="color:green">هیچ گذارشی برای داستان‌ها وجود ندارد.</p>
        }
         
        else
        {
            @foreach (var storyReport in StoryReports.Items)
            {
                <div class="report-box">

                    <!-- متن گزارش -->
                    <div class="report-text">
                        <p>علت گزارش:</p>
                        <p>@(string.IsNullOrEmpty(storyReport.ReportText) ? "(بدون متن)" : storyReport.ReportText)</p>
                    </div>

                    <!-- اطلاعات کاربر -->
                    <div class="target-user-status">
                        <p>@storyReport.TargetUser.FirstName @storyReport.TargetUser.LastName</p>

                        <div class="target-user-warnings">
                            <p>اخطارهای متهم:</p>

                            @if (storyReport.TargetUser.Warnings == null || storyReport.TargetUser.Warnings.Count == 0)
                            {
                                <p>هیچ اخطاری دریافت نکرده.</p>
                            }
                            else
                            {
                                @foreach (var w in storyReport.TargetUser.Warnings)
                                {
                                    <div class="warningBox">
                                        <p>علت: @w.Reason</p>
                                        <p>موضوع: @w.Subject</p>
                                        <p>جزئیات: @w.Details</p>
                                        <p>ساخته شده در @((DateTime.Now - w.CreatedAt).Days) روز پیش</p>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <button @onclick="@(() => Navigation.NavigateTo($"ReadStory/{storyReport.StoryGuid}"))">
                        مطالعه داستان
                    </button>

                    <label>
                        <input type="checkbox" @bind="IsReportAccepted" /> قبول گزارش
                    </label>

                    @if (IsReportAccepted)
                    {
                        <textarea @bind="SpecialMessage" placeholder="پیام شما به متخلف (اختیاری)" class="special-message"></textarea>
                    }

                    <button @onclick="() => CompeleteStoryReport(storyReport.PublicId)">تکمیل</button>
                </div>
            }
        }
    </div>



    <!-- کامنت‌ها -->
    <button class="accordion-button" @onclick="ReivewReportsListStates">
        <span>گزارشات کامنت‌ها</span>
        <span class="report-count">@ReviewReports?.TotalItems</span>
    </button>

    <div class="accordion-content" style="display:@(ShowComments ? "block" : "none")">
        @if (ReviewReports == null)
        {
            <p style="color:yellow">بارگذاری نشده...</p>
        }
        else if (ReviewReports.TotalItems == 0)
        {
            <p style="color:green">هیچ گذارشی برای کامنت ها وجود ندارد.</p>
        }
        else
        {
            @foreach (var commentReport in ReviewReports.Items)
            {
                <div class="report-box">

                    <!-- متن گزارش -->
                    <div class="report-text">
                        <p>علت گزارش:</p>
                        <p>@(string.IsNullOrEmpty(commentReport.ReportText) ? "(بدون متن)" : commentReport.ReportText)</p>
                    </div>

                    <!-- کاربر -->
                    <div class="target-user-status">
                        <p>@commentReport.TargetUser.FirstName @commentReport.TargetUser.LastName</p>

                        <div class="target-user-warnings">
                            <p>اخطارهای متهم:</p>

                            @if (commentReport.TargetUser.Warnings == null || commentReport.TargetUser.Warnings.Count == 0)
                            {
                                <p>هیچ اخطاری دریافت نکرده.</p>
                            }
                            else
                            {
                                @foreach (var w in commentReport.TargetUser.Warnings)
                                {
                                    <div class="warningBox">
                                        <p>علت: @w.Reason</p>
                                        <p>موضوع: @w.Subject</p>
                                        <p>جزئیات: @w.Details</p>
                                        <p>ساخته شده در @((DateTime.Now - w.CreatedAt).Days) روز پیش</p>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- کامنت -->
                    <div class="reported-comment">
                        <p>محتوای کامنت:</p>
                        <p>@commentReport.Object.Data</p>
                    </div>

                    <label>
                        <input type="checkbox" @bind="IsReportAccepted" /> قبول گزارش
                    </label>

                    @if (IsReportAccepted)
                    {
                        <textarea @bind="SpecialMessage" placeholder="پیام شما به متخلف (اختیاری)" class="special-message"></textarea>
                    }

                    <button @onclick="() => CompeleteCommentReport(commentReport.PublicId)">تکمیل</button>
                </div>
            }
        }
    </div>


    <!-- درخواست‌ها -->
    <button class="accordion-button" @onclick="ReleaseRequestsListStates">
        <span>درخواست‌های بازبینی</span>
        <span class="report-count">@StoryReleaseRequests?.TotalItems</span>
    </button>

    <div class="accordion-content" style="display:@(ShowRequests ? "block" : "none")">
        @if (StoryReleaseRequests == null)
        {
            <p style="color:yellow">بارگذاری نشده...</p>
        }
        else if (StoryReleaseRequests.TotalItems == 0)
        {
            <p style="color:green">هیچ درخواستی برای آزادی داستان‌ها وجود ندارد.</p>
        }
        else
        {
            @foreach (var req in StoryReleaseRequests.Items)
            {
                <div class="report-box">

                    @if (!string.IsNullOrEmpty(req.ReportText))
                    {
                        <div class="report-text">
                            <p>متن درخواست:</p>
                            <p>@req.ReportText</p>
                        </div>
                    }

                    <div class="target-user-status">
                        <p>@req.Report.TargetUser.FirstName @req.Report.TargetUser.LastName</p>

                        <div class="target-user-warnings">
                            <p>اخطارهای متهم:</p>

                            @if (req.Report.TargetUser.Warnings == null || req.Report.TargetUser.Warnings.Count == 0)
                            {
                                <p>هیچ اخطاری دریافت نکرده.</p>
                            }
                            else
                            {
                                @foreach (var w in req.Report.TargetUser.Warnings)
                                {
                                    <div class="warningBox">
                                        <p>علت: @w.Reason</p>
                                        <p>موضوع: @w.Subject</p>
                                        <p>جزئیات: @w.Details</p>
                                        <p>ساخته شده در @((DateTime.Now - w.CreatedAt).Days) روز پیش</p>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <button @onclick="@(() => Navigation.NavigateTo($"ReadStory/{req.Report.StoryGuid}"))">
                        مطالعه داستان
                    </button>

                    <label>
                        <input type="checkbox" @bind="IsReportAccepted" /> قبول گزارش
                    </label>

                    @if (IsReportAccepted)
                    {
                        <textarea @bind="SpecialMessage" placeholder="پیام شما به متخلف (اختیاری)" class="special-message"></textarea>
                    }

                    <button @onclick="() => CompeleteReleaseRequest(req.PublicId)">تکمیل</button>
                </div>
            }
        }
    </div>

</div>


<style>
    .reports-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        direction: rtl;
        font-family: sans-serif;
    }

    .accordion-button {
        width: 100%;
        background: #3f51b5;
        color: white;
        padding: 18px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        font-size: 20px;
        text-align: right;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

        .accordion-button:hover {
            background: #303f9f;
        }

    .accordion-content {
        background: #f7f7f7;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        display: none;
    }

    .report-box {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .report-text, .target-user-status, .reported-comment {
        margin-bottom: 15px;
        padding: 10px;
        background: #eeeeee;
        border-radius: 6px;
    }

    .warningBox {
        background: #fff3cd;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .special-message {
        width: 100%;
        padding: 10px;
        min-height: 100px;
        resize: vertical;
        margin-top: 10px;
        border-radius: 6px;
        border: 1px solid #999;
    }

    button {
        cursor: pointer;
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        margin-top: 10px;
    }

        button:hover {
            background: #449944;
        }

    .report-count {
        background: white;
        color: #3f51b5;
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 6px;
    }

</style>